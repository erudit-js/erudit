import { existsSync, mkdirSync, rmSync, write, writeFileSync } from 'node:fs';
import { consola } from 'consola';

import { alias2Relative } from './alias2Relative';

interface PrepareData {
    projectPath: string;
    eruditPath: string;
    //
    contentTargets?: string | string[];
}

export async function prepare({
    projectPath,
    eruditPath,
    contentTargets,
}: PrepareData) {
    const eruditBuildDir = `${projectPath}/.erudit`;
    const distDir = `${projectPath}/dist`;

    const nodeModules = `${projectPath}/node_modules`;
    const nodeModulesErudit = `${nodeModules}/erudit`;

    if (existsSync(nodeModulesErudit)) {
        consola.start('Resolving aliases in dependencies...');
        await alias2Relative(nodeModulesErudit, nodeModulesErudit);
        await alias2Relative(
            nodeModulesErudit,
            nodeModules + '/@erudit-js/bitran-elements',
        );
        consola.success('Resolved aliases in dependencies!');
    }

    consola.start('Cleaning up...');

    if (existsSync(distDir)) rmSync(distDir, { recursive: true });

    if (existsSync(eruditBuildDir)) rmSync(eruditBuildDir, { recursive: true });

    consola.success('Cleaned up!');

    consola.start('Generating Erudit build files...');

    mkdirSync(eruditBuildDir, { recursive: true });
    mkdirSync(eruditBuildDir + '/nuxt', { recursive: true });

    writeFileSync(
        `${eruditBuildDir}/nuxt/nuxt.config.ts`,
        `
        export default {
            compatibilityDate: '2025-01-01',
            extends: ['${eruditPath}'],
            future: {
                compatibilityVersion: 4,
            },
        }
    `,
    );

    writeFileSync(
        `${eruditBuildDir}/tsconfig.json`,
        JSON.stringify(
            {
                extends: './nuxt/.nuxt/tsconfig.json',
                compilerOptions: {
                    paths: {
                        '#project/*': [`${projectPath}/*`],
                        '#content/*': [`${projectPath}/content/*`],
                    },
                },
            },
            null,
            4,
        ),
    );

    await prepareContentTargets(eruditBuildDir, contentTargets);

    writeFileSync(
        `${eruditBuildDir}/__AUTOGENERATED__`,
        `This directory is autogenerated by Erudit CLI.\nAll changes will be lost on next launch!`,
    );

    consola.success('Erudit build files ready!');
}

async function prepareContentTargets(
    buildDir: string,
    targets?: string | string[],
) {
    if (typeof targets === 'undefined' || targets === '') {
        return;
    }

    if (typeof targets === 'string') {
        targets = [targets];
    }

    if (Array.isArray(targets)) {
        writeFileSync(
            `${buildDir}/targets.json`,
            JSON.stringify(targets, null, 4),
        );
        consola.success(`Saved ${targets.length} content targets!`);
        return;
    }

    throw new Error(`Failed to resolve content targets: "${targets}"!`);
}
